# Motion In Ocean - Management Mode Deployment
# Node registry hub service for coordinating multiple remote cameras
# No hardware access required; safe to run on any host
#
# Standard Usage:
#   docker compose up -d
#
# With docker-socket-proxy (for docker transport support):
#   docker compose --profile docker-socket-proxy up -d
#
# Requirements:
#   - Copy .env.example to .env and customize
#   - Optionally mount shared node registry volume (see "volumes" section)
#
# Node Connectivity:
#   - HTTP Transport (recommended): Register nodes with http://hostname:port
#   - Docker Transport: Register nodes with docker://proxy-host:port/container-id
#     Requires docker-socket-proxy to be running on remote docker hosts
#   - Private IPs: Blocked by default (SSRF protection)
#     Use docker network hostnames instead, or enable MIO_ALLOW_PRIVATE_IPS

services:
  motion-in-ocean:
    container_name: motion-in-ocean
    # Default: GitHub Container Registry. Docker Hub alternative:
    # image: cyanautomation/motioninocean:${MIO_IMAGE_TAG:-latest}
    image: ghcr.io/cyanautomation/motioninocean:${MIO_IMAGE_TAG:-latest}
    platform: linux/arm64
    restart: unless-stopped
    env_file: ./.env
    security_opt:
      - no-new-privileges:true
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Management mode configuration
    environment:
      TZ: ${TZ:-Europe/London}
      MIO_APP_MODE: ${MIO_APP_MODE:-management}

      # Infrastructure / Deployment Configuration (NOT UI-configurable)
      MIO_MOCK_CAMERA: ${MIO_MOCK_CAMERA:-false}
      MIO_ALLOW_PRIVATE_IPS: ${MIO_ALLOW_PRIVATE_IPS:-false}
      MIO_APPLICATION_SETTINGS_PATH: ${MIO_APPLICATION_SETTINGS_PATH:-/data/application-settings.json}
      MIO_MANAGEMENT_AUTH_TOKEN: ${MIO_MANAGEMENT_AUTH_TOKEN:-}
      MIO_NODE_DISCOVERY_SHARED_SECRET: ${MIO_NODE_DISCOVERY_SHARED_SECRET:-}
      MIO_NODE_REGISTRY_PATH: ${MIO_NODE_REGISTRY_PATH:-/data/node-registry.json}

      # System Configuration
      MIO_LIMITER_STORAGE_URI: ${MIO_LIMITER_STORAGE_URI:-memory://}

      # Error tracking (optional)
      MIO_SENTRY_DSN: ${MIO_SENTRY_DSN:-}

    ports:
      - "${MIO_BIND_HOST:-127.0.0.1}:${MIO_PORT:-8001}:8000"

    volumes:
      # Persistent storage for node registry
      - motion-in-ocean-data:/data

    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=2).read()",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Optional: Docker Socket Proxy for secure remote Docker API access
  # Profile: docker-socket-proxy (enable with --profile docker-socket-proxy)
  # Used for docker transport node connections (advanced feature)
  # Provides a read-only proxy to Docker API on this machine
  #
  # To enable:
  #   docker compose --profile docker-socket-proxy up -d
  #
  # Then register remote nodes with:
  #   docker://your-management-host:2375/container-name
  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:latest
    container_name: docker-socket-proxy
    profiles: ["docker-socket-proxy"]
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    ports:
      - "${MIO_BIND_HOST:-127.0.0.1}:${MIO_DOCKER_PROXY_PORT:-2375}:2375"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Minimal read-only permissions for security
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
      PING: 1
      SERVICES: 1
      STATS: 1
      TASKS: 1
      VERSION: 1
      # Deny dangerous operations
      AUTH: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      POST: 0
      SECRETS: 0
      SYSTEM: 0
      VOLUMES: 0
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test:
        [
          "CMD-SHELL",
          'python3 -c "import socket; socket.create_connection((''localhost'', 8000), timeout=3)" 2>/dev/null || exit 1',
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  motion-in-ocean-data:
    driver: local

# To use a shared node registry volume across multiple hosts:
# 1. Create a named volume on your Docker host:
#    docker volume create motion-in-ocean-registry
# 2. Uncomment the alternative volumes section below
# 3. Ensure the volume is accessible from all remote webcam nodes

# Alternative (shared registry - requires pre-created named volume):
# volumes:
#   motion-in-ocean-data:
#     external: true
#     name: motion-in-ocean-registry
