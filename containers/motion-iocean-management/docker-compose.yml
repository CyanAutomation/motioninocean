# Motion In Ocean - Management Mode Deployment
# Node registry hub service for coordinating multiple remote cameras
# No hardware access required; safe to run on any host
#
# Standard Usage:
#   docker compose up -d
#
# Requirements:
#   - Copy .env.example to .env and customize
#   - Optionally mount shared node registry volume (see "volumes" section)

services:
  motion-in-ocean:
    container_name: motion-in-ocean
    image: ghcr.io/cyanautomation/motioninocean:${MOTION_IN_OCEAN_IMAGE_TAG:-latest}
    platform: linux/arm64
    restart: unless-stopped
    env_file: ./.env
    security_opt:
      - no-new-privileges:true
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Management mode configuration
    environment:
      TZ: ${TZ:-Europe/London}
      APP_MODE: management

      # Management mode ignores camera configuration
      MOCK_CAMERA: ${MOCK_CAMERA:-false}

    ports:
      - "${MOTION_IN_OCEAN_BIND_HOST:-127.0.0.1}:${MOTION_IN_OCEAN_PORT:-8001}:8000"

    volumes:
      # Persistent storage for node registry
      - motion-in-ocean-data:/data

    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  motion-in-ocean-data:
    driver: local

# To use a shared node registry volume across multiple hosts:
# 1. Create a named volume on your Docker host:
#    docker volume create motion-in-ocean-registry
# 2. Uncomment the alternative volumes section below
# 3. Ensure the volume is accessible from all remote webcam nodes

# Alternative (shared registry - requires pre-created named volume):
# volumes:
#   motion-in-ocean-data:
#     external: true
#     name: motion-in-ocean-registry
