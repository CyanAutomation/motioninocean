# Motion In Ocean - Webcam Mode Deployment
# Streaming-only deployment with simplified device access
#
# Standard Usage:
#   docker compose up -d
#
# With Hardened Security (explicit device mappings):
#   docker compose -f docker-compose.yml -f docker-compose.hardened.yml up -d
#
# With Mock Camera (for testing without hardware):
#   docker compose -f docker-compose.yml -f docker-compose.mock.yml up -d
#
# With Mock Camera + Animated Cat GIFs (for demos/fun!):
#   MOCK_CAMERA=true CAT_GIF=true \
#   docker compose -f docker-compose.yml -f docker-compose.mock.yml -f docker-compose.cat-gif.yml up -d
#
# Requirements:
#   - Copy .env.example to .env and customize
#   - (Optional) Run ../detect-devices.sh to generate docker-compose.override.yml

services:
  motion-in-ocean:
    container_name: motion-in-ocean
    image: ghcr.io/cyanautomation/motioninocean:${MOTION_IN_OCEAN_IMAGE_TAG:-latest}
    platform: linux/arm64
    restart: unless-stopped
    env_file: ./.env
    security_opt:
      - no-new-privileges:true
    stop_grace_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    # Webcam mode configuration
    environment:
      TZ: ${TZ:-Europe/London}
      MOTION_IN_OCEAN_APP_MODE: ${MOTION_IN_OCEAN_APP_MODE:-webcam}

      # Infrastructure / Deployment Configuration (NOT UI-configurable)
      MOTION_IN_OCEAN_PI3_PROFILE: ${MOTION_IN_OCEAN_PI3_PROFILE:-false}
      MOTION_IN_OCEAN_OCTOPRINT_COMPATIBILITY: ${MOTION_IN_OCEAN_OCTOPRINT_COMPATIBILITY:-false}
      MOTION_IN_OCEAN_CORS_ORIGINS: ${MOTION_IN_OCEAN_CORS_ORIGINS:-*}
      MOTION_IN_OCEAN_MOCK_CAMERA: ${MOTION_IN_OCEAN_MOCK_CAMERA:-false}
      MOTION_IN_OCEAN_CAT_GIF: ${MOTION_IN_OCEAN_CAT_GIF:-false}
      MOTION_IN_OCEAN_CATAAS_API_URL: ${MOTION_IN_OCEAN_CATAAS_API_URL:-https://cataas.com/cat/gif}
      MOTION_IN_OCEAN_APPLICATION_SETTINGS_PATH: ${MOTION_IN_OCEAN_APPLICATION_SETTINGS_PATH:-/data/application-settings.json}
      MOTION_IN_OCEAN_SENTRY_DSN: ${MOTION_IN_OCEAN_SENTRY_DSN:-}
      MOTION_IN_OCEAN_BASE_URL: ${MOTION_IN_OCEAN_BASE_URL:-}

      # Authentication & Security
      MOTION_IN_OCEAN_MANAGEMENT_AUTH_TOKEN: ${MOTION_IN_OCEAN_MANAGEMENT_AUTH_TOKEN:-}
      MOTION_IN_OCEAN_WEBCAM_CONTROL_PLANE_AUTH_TOKEN: ${MOTION_IN_OCEAN_WEBCAM_CONTROL_PLANE_AUTH_TOKEN:-}
      MOTION_IN_OCEAN_ALLOW_PRIVATE_IPS: ${MOTION_IN_OCEAN_ALLOW_PRIVATE_IPS:-false}

      # System Configuration
      MOTION_IN_OCEAN_NODE_REGISTRY_PATH: ${MOTION_IN_OCEAN_NODE_REGISTRY_PATH:-/data/node-registry.json}
      MOTION_IN_OCEAN_LIMITER_STORAGE_URI: ${MOTION_IN_OCEAN_LIMITER_STORAGE_URI:-memory://}
      MOTION_IN_OCEAN_ALLOW_PYKMS_MOCK: ${MOTION_IN_OCEAN_ALLOW_PYKMS_MOCK:-false}

    ports:
      - "${MOTION_IN_OCEAN_BIND_HOST:-127.0.0.1}:${MOTION_IN_OCEAN_PORT:-8000}:8000"

    volumes:
      - /run/udev:/run/udev:ro
      - /dev/dma_heap:/dev/dma_heap
      - motion-in-ocean-data:/data

    # Privileged mode allows access to all host devices
    # Suitable for homelab deployments on trusted networks
    # For production, use: docker compose -f docker-compose.yml -f docker-compose.hardened.yml
    privileged: true

    group_add:
      - video
      - render

    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=2).read()"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  motion-in-ocean-data:
    driver: local
