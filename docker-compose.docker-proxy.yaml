# Motion In Ocean - Docker Socket Proxy (Optional)
# Provides secure proxy access to Docker daemon for remote node discovery
# Usage: docker compose -f docker-compose.webcam.yaml -f docker-compose.docker-proxy.yaml up
#
# This service acts as a security boundary between the motion-in-ocean container
# and the Docker daemon, limiting access to only safe operations (read-only queries).
# See: https://github.com/Tecnativa/docker-socket-proxy#restrictive-permissions

services:
  docker-socket-proxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:0.1.42
    container_name: docker-socket-proxy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

    ports:
      - "${MOTION_IN_OCEAN_BIND_HOST:-127.0.0.1}:${DOCKER_PROXY_PORT:-2375}:2375"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

    environment:
      # Grant minimal read-only permissions for node discovery
      # These allow safe operations only; all write/delete operations are blocked
      CONTAINERS: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
      PING: 1
      SERVICES: 1
      STATS: 1
      TASKS: 1
      VERSION: 1
      
      # Explicitly deny dangerous operations for security
      AUTH: 0
      BUILD: 0
      COMMIT: 0
      CONFIGS: 0
      DISTRIBUTION: 0
      EXEC: 0
      GRPC: 0
      POST: 0
      SECRETS: 0
      SYSTEM: 0
      VOLUMES: 0

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:2375/version || exit 1"]
      interval: 2m
      timeout: 5s
      retries: 3
      start_period: 10s
