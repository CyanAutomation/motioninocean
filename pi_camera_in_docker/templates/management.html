<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="motion-in-ocean - Node Management" />
    <title>motion-in-ocean - Node Management</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/management.css') }}" />
  </head>
  <body>
    <header class="management-header">
      <h1>Node Management</h1>
      <p class="subtitle">Manage webcam nodes and monitor node health.</p>
      <div class="management-token-control">
        <label for="management-api-token">Management API Bearer Token (optional)</label>
        <input
          id="management-api-token"
          name="management_api_token"
          type="password"
          autocomplete="off"
          placeholder="Paste token for protected /api requests"
        />
        <small>
          If management API auth is enabled, provide a token and click Refresh to retry failed
          requests.
        </small>
      </div>
    </header>

    <main class="management-layout">
      <section class="node-form-panel ui-card">
        <div class="panel-header ui-panel-header">
          <h2 id="form-title">Add node</h2>
          <button
            id="toggle-node-form-panel-btn"
            class="ui-btn ui-btn--secondary"
            type="button"
            aria-label="Collapse node form panel"
            aria-expanded="true"
            aria-controls="node-form-content"
          >
            Collapse
          </button>
        </div>
        <div id="node-form-content">
          <form id="node-form">
            <input type="hidden" id="editing-node-id" value="" />

            <div class="ui-form-control">
              <label for="node-id">Node ID</label>
              <input
                id="node-id"
                name="id"
                pattern="[a-zA-Z0-9_-]+"
                maxlength="64"
                title="Only alphanumeric characters, hyphens, and underscores allowed"
                required
              />
            </div>

            <div class="ui-form-control">
              <label for="node-name">Name</label>
              <input id="node-name" name="name" maxlength="128" required />
            </div>

            <div class="ui-form-control">
              <label for="node-base-url">Base URL</label>
              <input id="node-base-url" name="base_url" placeholder="" required />
            </div>

            <div class="ui-form-control">
              <label for="node-transport">Transport</label>
              <select id="node-transport" name="transport">
                <option value="http" selected>http</option>
                <option value="docker">docker</option>
              </select>
            </div>

            <div class="ui-form-control">
              <label for="node-auth-type">Auth Type</label>
              <select id="node-auth-type" name="auth_type">
                <option value="none" selected>none</option>
                <option value="bearer">bearer</option>
              </select>
            </div>

            <div class="ui-form-control">
              <label for="node-auth-token">Remote Node Token (optional)</label>
              <input
                id="node-auth-token"
                name="auth_token"
                placeholder="Set to the remote node MANAGEMENT_AUTH_TOKEN"
              />
              <small>
                For webcam nodes, use the same token configured in that node's `.env`
                (`MANAGEMENT_AUTH_TOKEN`).
              </small>
            </div>

            <div class="ui-form-control">
              <label for="node-capabilities">Capabilities (comma-separated)</label>
              <input id="node-capabilities" name="capabilities" placeholder="stream, snapshot" />
            </div>

            <div class="ui-form-control">
              <label for="node-labels">Labels JSON (optional)</label>
              <textarea
                id="node-labels"
                name="labels"
                rows="4"
                placeholder='{"location":"lab"}'
              ></textarea>
            </div>

            <div class="actions">
              <button type="submit" id="save-node-btn" class="ui-btn ui-btn--primary">
                Save node
              </button>
              <button type="button" id="cancel-edit-btn" class="ui-btn ui-btn--secondary hidden">
                Cancel edit
              </button>
            </div>
          </form>
          <p id="form-feedback" class="feedback" aria-live="polite"></p>
        </div>
      </section>

      <section class="node-list-panel ui-card">
        <div class="table-header ui-panel-header">
          <h2>Registered nodes</h2>
          <button id="refresh-nodes-btn" class="ui-btn ui-btn--secondary">Refresh</button>
        </div>

        <div class="node-table-wrap">
          <table class="node-table" aria-label="Registered node list">
            <thead>
              <tr>
                <th>Node</th>
                <th>Base URL</th>
                <th>Transport</th>
                <th>Discovery</th>
                <th>Status</th>
                <th>Details</th>
                <th>Stream</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="nodes-table-body">
              <tr>
                <td colspan="8" class="empty">No nodes registered.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="ui-form-control">
          <input
            id="advanced-diagnostics-toggle"
            type="checkbox"
            aria-controls="diagnostic-panel-content"
            aria-expanded="false"
          />
          <label for="advanced-diagnostics-toggle">Advanced (show diagnostic report)</label>
        </div>

        <section
          id="diagnostic-panel"
          class="diagnostic-panel"
          aria-live="polite"
          aria-label="Node diagnostics panel"
          tabindex="-1"
        >
          <div id="diagnostic-panel-content" hidden>
            <div class="diagnostic-panel__header">
              <h3>Diagnostic report</h3>
              <button
                id="copy-diagnostic-report-btn"
                class="ui-btn ui-btn--secondary"
                type="button"
                disabled
              >
                Copy report
              </button>
            </div>

            <div class="diagnostic-meta-row" id="diagnostic-meta-row">
              <span>Node: <strong id="diagnostic-node-id">â€”</strong></span>
              <span>Context: <strong id="diagnostic-context">No report loaded</strong></span>
              <span>
                Summary:
                <span id="diagnostic-summary-badge" class="diagnostic-pill diagnostic-pill--neutral"
                  >Idle</span
                >
              </span>
            </div>

            <div class="diagnostic-summary-banner" id="diagnostic-summary-banner">
              <div class="diagnostic-summary-banner__top">
                <span
                  id="diagnostic-overall-state-pill"
                  class="diagnostic-pill diagnostic-pill--neutral"
                  >Idle</span
                >
                <strong id="diagnostic-summary-cta">Run diagnostics</strong>
              </div>
              <p id="diagnostic-summary-interpretation">
                Run Diagnose on a node to generate remediation guidance.
              </p>
            </div>

            <div id="diagnostic-checks-grid" class="diagnostic-checks-grid">
              <p class="diagnostic-empty">Run Diagnose on a node to view structured checks.</p>
            </div>

            <div class="diagnostic-recommendations" id="diagnostic-recommendations">
              <h4>Recommendations</h4>
              <ul>
                <li>No recommendations yet.</li>
              </ul>
            </div>
          </div>
        </section>
      </section>
    </main>

    <script type="module" src="{{ url_for('static', filename='js/management.js') }}"></script>
  </body>
</html>
