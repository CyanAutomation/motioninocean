name: Build and publish Docker image

on:
  # Manual trigger
  workflow_dispatch: {}
  # Trigger on pushed tags
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository }}
            cyanautomation/motioninocean
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push (Debian bookworm) - PRIMARY
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64,linux/amd64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            INCLUDE_MOCK_CAMERA=true
          cache-from: type=gha
          cache-to: type=gha,mode=max
        id: build_bookworm

      - name: Build test variant (Bookworm) in parallel
        if: success()
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/arm64
          push: false
          build-args: |
            INCLUDE_MOCK_CAMERA=true
          cache-from: type=gha
          outputs: type=oci,dest=/tmp/test-bookworm-image
        continue-on-error: true

      - name: Extract changelog for release
        id: changelog
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -e
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}

          echo "Extracting changelog for version: ${VERSION}"

          # Extract the section for this version from CHANGELOG.md
          if [ -f "CHANGELOG.md" ]; then
            # Use awk to extract content between version headers
            CHANGELOG_CONTENT=$(awk "/## \[${VERSION}\]/,/## \[.*\]/{if (/## \[${VERSION}\]/) {found=1; next} if (/## \[.*\]/ && found) exit; if (found) print}" CHANGELOG.md | sed '/^$/d')

            if [ -z "$CHANGELOG_CONTENT" ]; then
              echo "Warning: No changelog section found for version ${VERSION}"
              CHANGELOG_CONTENT="Release ${VERSION} - See commit history for details."
            else
              echo "Found changelog section for version ${VERSION}"
            fi
          else
            echo "Warning: CHANGELOG.md not found"
            CHANGELOG_CONTENT="Release ${VERSION} - See commit history for details."
          fi

          # Write to file to preserve multiline content
          echo "$CHANGELOG_CONTENT" > /tmp/changelog.txt
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT

          # Debug output
          echo "Changelog content length: $(wc -c < /tmp/changelog.txt) bytes"

      - name: Build release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -e

          # Read changelog from file
          CHANGELOG_BODY=$(cat /tmp/changelog.txt)

          # Get variables
          TAG_NAME="${{ steps.changelog.outputs.tag_name }}"
          VERSION="${{ steps.changelog.outputs.version }}"
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(basename "${{ github.repository }}")

          # Build release notes incrementally
          {
            echo "$CHANGELOG_BODY"
            echo ""
            echo "## Docker Images"
            echo ""
            echo "Pull the image (GitHub Container Registry):"
            echo '```bash'
            echo "docker pull ghcr.io/${REPO_LOWER}:${TAG_NAME}"
            echo "# or"
            echo "docker pull ghcr.io/${REPO_LOWER}:${VERSION}"
            echo "# or"
            echo "docker pull ghcr.io/${REPO_LOWER}:latest"
            echo '```'
            echo ""
            echo "Pull the image (Docker Hub):"
            echo '```bash'
            echo "docker pull cyanautomation/motioninocean:${TAG_NAME}"
            echo "# or"
            echo "docker pull cyanautomation/motioninocean:${VERSION}"
            echo "# or"
            echo "docker pull cyanautomation/motioninocean:latest"
            echo '```'
            echo ""
            echo "View on GitHub Container Registry: https://github.com/${{ github.repository }}/pkgs/container/${REPO_NAME}"
            echo "View on Docker Hub: https://hub.docker.com/r/cyanautomation/motioninocean"
          } > /tmp/release_notes.md

          echo "Release notes built successfully"
          echo "Release notes length: $(wc -c < /tmp/release_notes.md) bytes"

      - name: Validate release notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -e

          # Check if release notes file exists and is not empty
          if [ ! -f /tmp/release_notes.md ]; then
            echo "Error: Release notes file not found"
            exit 1
          fi

          if [ ! -s /tmp/release_notes.md ]; then
            echo "Error: Release notes file is empty"
            exit 1
          fi

          # Check minimum length (at least 10 characters)
          NOTES_LENGTH=$(wc -c < /tmp/release_notes.md)
          if [ "$NOTES_LENGTH" -lt 10 ]; then
            echo "Error: Release notes too short (${NOTES_LENGTH} bytes)"
            exit 1
          fi

          echo "✓ Release notes validation passed"
          echo "  Length: ${NOTES_LENGTH} bytes"

          # Show preview (first 200 chars)
          echo "  Preview:"
          head -c 200 /tmp/release_notes.md
          echo ""

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          TAG_NAME="${{ steps.changelog.outputs.tag_name }}"

          echo "Creating GitHub Release for ${TAG_NAME}"

          # Create release using gh CLI with notes from file
          gh release create "${TAG_NAME}" \
            --repo "${{ github.repository }}" \
            --title "Release ${TAG_NAME}" \
            --notes-file /tmp/release_notes.md

          echo "✓ GitHub Release created successfully"
          echo "  URL: https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}"
